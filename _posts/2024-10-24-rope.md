---
layout: post
title: RoPE ä½ç½®ç¼–ç ç®—æ³•è¯¦è§£
date: 2024-10-24 20:00:00
summary: æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼ŒRoPEï¼‰æ˜¯è®ºæ–‡ Roformer Enhanced Transformer With Rotray Position Embedding æå‡ºçš„ä¸€ç§èƒ½å¤Ÿå°†ç›¸å¯¹ä½ç½®ä¿¡æ¯ä¾èµ–é›†æˆåˆ° self-attention ä¸­å¹¶æå‡ transformer æ¶æ„æ€§èƒ½çš„ä½ç½®ç¼–ç æ–¹å¼ã€‚
categories: Transformer
---

- [ä¸€ èƒŒæ™¯çŸ¥è¯†](#ä¸€-èƒŒæ™¯çŸ¥è¯†)
  - [1.1 torch ç›¸å…³å‡½æ•°](#11-torch-ç›¸å…³å‡½æ•°)
  - [1.2 ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ç¼–ç ](#12-ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ç¼–ç )
  - [1.2 æ­£å¼¦ä½ç½®ç¼–ç ](#12-æ­£å¼¦ä½ç½®ç¼–ç )
- [äºŒ æ—‹è½¬ä½ç½®ç¼–ç  RoPE](#äºŒ-æ—‹è½¬ä½ç½®ç¼–ç -rope)
  - [2.1 RoPE ç®—æ³•åŸç†](#21-rope-ç®—æ³•åŸç†)
  - [2.2 äºŒç»´ä½ç½®ç¼–ç ](#22-äºŒç»´ä½ç½®ç¼–ç )
  - [2.3 å¤šç»´çš„ RoPE ç®—æ³•](#23-å¤šç»´çš„-rope-ç®—æ³•)
- [ä¸‰ RoPE çš„ pytorch å®ç°](#ä¸‰-rope-çš„-pytorch-å®ç°)
  - [3.1 RoPE å®ç°æµç¨‹](#31-rope-å®ç°æµç¨‹)
  - [3.2 RoPE çš„æ—‹è½¬çŸ©é˜µå®ç°](#32-rope-çš„æ—‹è½¬çŸ©é˜µå®ç°)
  - [3.3 apply\_rotary\_pos\_emb å®ç°](#33-apply_rotary_pos_emb-å®ç°)
    - [å‡½æ•° f å®ç°æ‹†è§£](#å‡½æ•°-f-å®ç°æ‹†è§£)
    - [æ€»ç»“](#æ€»ç»“)
    - [æµ‹è¯•ä»£ç ](#æµ‹è¯•ä»£ç )
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼Œ`RoPE`ï¼‰æ˜¯è®ºæ–‡ Roformer: Enhanced Transformer With Rotray Position Embedding æå‡ºçš„ä¸€ç§èƒ½å¤Ÿ**å°†ç›¸å¯¹ä½ç½®ä¿¡æ¯é›†æˆåˆ° self-attention ä¸­**ï¼Œç”¨ä»¥æå‡ transformer æ¶æ„æ€§èƒ½çš„ä½ç½®ç¼–ç æ–¹å¼ã€‚

å’Œ `Sinusoidal` ä½ç½®ç¼–ç ç›¸æ¯”ï¼Œ`RoPE` å…·æœ‰æ›´å¥½çš„å¤–æ¨æ€§ï¼Œç›®å‰æ˜¯å¤§æ¨¡å‹ç›¸å¯¹ä½ç½®ç¼–ç ä¸­åº”ç”¨æœ€å¹¿çš„ç®—æ³•ä¹‹ä¸€ã€‚è¿™é‡Œçš„å¤–æ¨æ€§å®è´¨æ˜¯ä¸€ä¸ª**è®­ç»ƒå’Œé¢„æµ‹çš„æ–‡æœ¬é•¿åº¦ä¸ä¸€è‡´çš„é—®é¢˜**ã€‚å…·ä½“æ¥è¯´ï¼Œä¸ä¸€è‡´çš„åœ°æ–¹æœ‰ä¸¤ç‚¹ï¼š
1. é¢„æµ‹çš„æ—¶å€™ç”¨åˆ°äº†æ²¡è®­ç»ƒè¿‡çš„ä½ç½®ç¼–ç ï¼ˆä¸ç®¡ç»å¯¹è¿˜æ˜¯ç›¸å¯¹ï¼‰ï¼›
2. é¢„æµ‹çš„æ—¶å€™æ³¨æ„åŠ›æœºåˆ¶æ‰€å¤„ç†çš„ token æ•°é‡è¿œè¶…è®­ç»ƒæ—¶çš„æ•°é‡ã€‚

RoPE çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†**ä½ç½®ç¼–ç **ä¸**è¯å‘é‡**é€šè¿‡**æ—‹è½¬çŸ©é˜µ**ç›¸ä¹˜ï¼Œå³å°†ä¸€ä¸ªå‘é‡æ—‹è½¬æŸä¸ªè§’åº¦ï¼Œä¸ºå…¶èµ‹äºˆä½ç½®ä¿¡æ¯ã€‚å…¶å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

1. ç›¸å¯¹ä½ç½®æ„ŸçŸ¥ï¼šRoPE èƒ½å¤Ÿè‡ªç„¶åœ°æ•æ‰è¯æ±‡ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å…³ç³»ã€‚
2. æ— éœ€é¢å¤–çš„è®¡ç®—ï¼šä½ç½®ç¼–ç ä¸è¯å‘é‡çš„ç»“åˆåœ¨è®¡ç®—ä¸Šæ˜¯é«˜æ•ˆçš„ã€‚
3. é€‚åº”ä¸åŒé•¿åº¦çš„åºåˆ—ï¼šRoPE å¯ä»¥çµæ´»å¤„ç†ä¸åŒé•¿åº¦çš„è¾“å…¥åºåˆ—ã€‚

> ä¸‰è§’å‡½æ•°ã€æ—‹è½¬çŸ©é˜µã€æ¬§æ‹‰å…¬å¼ã€å¤æ•°ç­‰æ•°å­¦èƒŒæ™¯çŸ¥è¯†å¯ä»¥å‚è€ƒè¿™ç¯‡[æ–‡ç« ](./ä½ç½®ç¼–ç ç®—æ³•èƒŒæ™¯çŸ¥è¯†.md)å­¦ä¹ ã€‚

## ä¸€ èƒŒæ™¯çŸ¥è¯†

### 1.1 torch ç›¸å…³å‡½æ•°

1ï¼Œ`torch.outer` 

å‡½æ•°ä½œç”¨ï¼štorch.outer(a, b) è®¡ç®—ä¸¤ä¸ª 1D å‘é‡ a å’Œ b çš„å¤–ç§¯ï¼Œç”Ÿæˆä¸€ä¸ªäºŒç»´çŸ©é˜µï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ çš„è®¡ç®—æ–¹å¼ä¸ºï¼š

$$\text{result}[i, j] = a[i] \times b[j]$$

å³ï¼ŒçŸ©é˜µçš„ç¬¬ $i$ è¡Œã€ç¬¬ $j$ åˆ—çš„å…ƒç´ ç­‰äºå‘é‡ a çš„ç¬¬ $i$ ä¸ªå…ƒç´ ä¸å‘é‡ b çš„ç¬¬ $j$ ä¸ªå…ƒç´ çš„ä¹˜ç§¯ã€‚

å¤–ç§¯ï¼ˆouter productï¼‰æ˜¯æŒ‡ä¸¤ä¸ªå‘é‡ $a$ å’Œ $b$ é€šè¿‡å¤–ç§¯æ“ä½œç”Ÿæˆçš„çŸ©é˜µï¼š

$$\mathbf{A} = a \otimes b$$

å…¶ä¸­ $a \otimes b$ ç”Ÿæˆä¸€ä¸ªçŸ©é˜µï¼Œè¡Œæ•°ç­‰äºå‘é‡ $a$ çš„å…ƒç´ æ•°ï¼Œåˆ—æ•°ç­‰äºå‘é‡ $b$ çš„å…ƒç´ æ•°ã€‚

```bash
>>> a = torch.tensor([2,3,1,1,2], dtype=torch.int8)
>>> b = torch.tensor([4,2,3], dtype=torch.int8)
>>> c = torch.outer(a, b)
>>> c.shape
torch.Size([5, 3])
>>> c
tensor([[ 8,  4,  6],
        [12,  6,  9],
        [ 4,  2,  3],
        [ 4,  2,  3],
        [ 8,  4,  6]], dtype=torch.int8)
```

2ï¼Œ`torch.matmul`

å¯ä»¥å¤„ç†æ›´é«˜ç»´çš„å¼ é‡ã€‚å½“è¾“å…¥å¼ é‡çš„ç»´åº¦å¤§äº 2 æ—¶ï¼Œå®ƒå°†æ‰§è¡Œæ‰¹é‡çŸ©é˜µä¹˜æ³•ã€‚

```bash
>>> A = torch.randn(10, 3, 4)
>>> B = torch.randn(10, 4, 7)
>>> C = torch.matmul(A, B)
>>> D = torch.bmm(A, B)
>>> assert C.shape == D.shape # shape is torch.Size([10, 3, 7])
>>> True
```

3ï¼Œ`torch.polar`

```python
# ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç»å¯¹å€¼ï¼ˆæ¨¡ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è§’åº¦
torch.polar(abs, angle, *, out=None) â†’ Tensor
```

æ„é€ ä¸€ä¸ªå¤æ•°å¼ é‡ï¼Œå…¶å…ƒç´ æ˜¯æåæ ‡å¯¹åº”çš„ç¬›å¡å°”åæ ‡ï¼Œç»å¯¹å€¼ä¸º absï¼Œè§’åº¦ä¸º angleã€‚

$$\text{out=absâ‹…cos(angle)+absâ‹…sin(angle)â‹…j}$$

```python
# å‡è®¾ freqs = [x, y], åˆ™ torch.polar(torch.ones_like(freqs), freqs) 
# = [cos(x) + sin(x)j, cos(y) + sin(y)j]
>>> angle = torch.tensor([np.pi / 2, 5 * np.pi / 4], dtype=torch.float64)
>>> z = torch.polar(torch.ones_like(angle), angle)
>>> z
tensor([ 6.1232e-17+1.0000j, -7.0711e-01-0.7071j], dtype=torch.complex128)
>>> a = torch.tensor([np.pi / 2], dtype=torch.float64) # æ•°æ®ç±»å‹å¿…é¡»å’Œå‰é¢ä¸€æ ·
>>> torch.cos(a)
tensor([6.1232e-17], dtype=torch.float64)
```

4ï¼Œ`torch.repeat_interleave`

```python
# ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¾“å…¥å¼ é‡
# ç¬¬äºŒä¸ªå‚æ•°æ˜¯é‡å¤æ¬¡æ•°
# dim: æ²¿ç€è¯¥ç»´åº¦é‡å¤å…ƒç´ ã€‚å¦‚æœæœªæŒ‡å®šç»´åº¦ï¼Œé»˜è®¤ä¼šå°†è¾“å…¥æ•°ç»„å±•å¹³æˆä¸€ç»´ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¹³å¦çš„è¾“å‡ºæ•°ç»„ã€‚
torch.repeat_interleave(input, repeats, dim=None, *, output_size=None) â†’ Tensor
```
è¿”å›ä¸€ä¸ªå…·æœ‰ä¸è¾“å…¥ç›¸åŒç»´åº¦çš„é‡å¤å¼ é‡

```bash
>>> keys = torch.randn([2, 12, 8, 512])
>>> keys2 = torch.repeat_interleave(keys, 8, dim = 2)
>>> keys2.shape
torch.Size([2, 12, 64, 512])
>>> x
tensor([[1, 2],
        [3, 4]])
>>> torch.repeat_interleave(x, 3, dim=1)
tensor([[1, 1, 1, 2, 2, 2],
        [3, 3, 3, 4, 4, 4]])
>>> torch.repeat_interleave(x, 3)
tensor([1, 1, 1, 3, 3, 3, 4, 4, 4, 5, 5, 5])
```

**æ³¨æ„é‡å¤åå…ƒç´ çš„é¡ºåº**ï¼Œä»¥ç®€å•çš„ä¸€ç»´ä¸ºä¾‹ `x = [a,b,c,d]`ï¼Œ`torch.repeat_interleave(x, 3)` åï¼Œç»“æœæ˜¯ `[a,a,a,b,b,b,c,c,c,d,d,d]`ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ç¼–ç 

å‡è®¾ $q_m$ å’Œ $k_n$ åˆ†åˆ«è¡¨ç¤ºè¯å‘é‡ $q$ ä½äºä½ç½® $m$ å’Œè¯å‘é‡ $k$ ä½äºä½ç½® $n$ï¼Œä¸¤è€…ä¹‹é—´çš„æ³¨æ„åŠ›æƒé‡è®¡ç®—å…¬å¼å¦‚ä¸‹:

$$a_{m,n} = \frac{\exp\left(\frac{q_m^T k}{\sqrt{d}}\right)}{\sum_{j=1}^{N} \exp\left(\frac{q_m^T k_j}{\sqrt{d}}\right)} \\
o_m = \sum_{n=1}^{N} a_{m,n} v_n \tag{1}$$

å¾ˆæ˜æ˜¾ï¼Œåœ¨æœªåŠ å…¥ä½ç½®ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œæ— è®ºè¯å‘é‡ $q$ å’Œ $k$ æ‰€å¤„çš„ä½ç½®å¦‚ä½•å˜åŒ–ï¼Œ**$qk$ çš„æ³¨æ„åŠ›æƒé‡ $a_{m,n}$ å‡ä¸ä¼šå‘ç”Ÿå˜åŒ–**ï¼Œä¹Ÿå°±æ˜¯**æ³¨æ„åŠ›æƒé‡å’Œä½ç½®æ— å…³**ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç›´è§‰ã€‚æ­£å¸¸çš„åº”è¯¥æ˜¯ï¼Œå¯¹äºä¸¤ä¸ªè¯å‘é‡ï¼Œå¦‚æœå®ƒä»¬ä¹‹é—´çš„è·ç¦»è¾ƒè¿‘ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä»¬ä¹‹é—´çš„çš„æ³¨æ„åŠ›æƒé‡æ›´å¤§ï¼Œå½“è·ç¦»è¾ƒè¿œæ—¶ï¼Œæ³¨æ„åŠ›æƒé‡æ›´å°ã€‚

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¨¡å‹å¼•å…¥ä½ç½®ç¼–ç ï¼Œ**è®©æ¯ä¸ªè¯å‘é‡éƒ½èƒ½å¤Ÿæ„ŸçŸ¥åˆ°å®ƒåœ¨è¾“å…¥åºåˆ—ä¸­æ‰€å¤„çš„ä½ç½®ä¿¡æ¯**ã€‚å®šä¹‰å¦‚ä¸‹å‡½æ•° $f$ï¼Œè¡¨ç¤ºå¯¹è¯å‘é‡ $q$ æ³¨å…¥ä½ç½®ä¿¡æ¯ $m$å¾—åˆ° $q_m$ï¼š

$$q_m = f(q, m) \tag{2}$$   

åŒç† $$k_n = f(k, n)$$

åˆ™ $q_m$ ä¸ $k_n$ ä¹‹é—´çš„æ³¨æ„åŠ›æƒé‡å¯è¡¨ç¤ºä¸ºï¼š

$$a_{m,n} = \frac{\exp\left(\frac{f(q,m)^Tf(k,n)}{\sqrt{a}}\right)}{\sum_{j=1}^{N}\exp\left(\frac{f(q,m)^Tf(k,j)}{\sqrt{a}}\right)}$$

> æ³¨æ„ï¼Œè¿™é‡Œçš„ $f$ å…¶å®æ˜¯æŠŠ $\text{embedding}\_\text{vector} \times W_q$ çš„çŸ©é˜µä¹˜æ³•è¿‡ç¨‹åŒ…å«è¿›å»äº†ã€‚

### 1.2 æ­£å¼¦ä½ç½®ç¼–ç 

æ–¹ç¨‹ (2) çš„ä¸€ç§å¸¸è§ï¼ˆtransformer è®ºæ–‡ç”¨çš„ä½™å¼¦ä½ç½®ç¼–ç ï¼‰å…¬å¼æ˜¯ï¼š

$$f_t:tâˆˆ\{q,k,v\}(x_i, i) := W_{t}(x_i + p_i)ï¼Œ\tag{3}$$

å…¶ä¸­ï¼Œ$p_i \in \mathbb{R}^d$  æ˜¯ä¸ `token` $x_i$ çš„ä½ç½®ç›¸å…³çš„ $d$ ç»´å‘é‡ï¼ŒVaswani ç­‰äºº [2017] åˆ™æå‡ºäº†é€šè¿‡æ­£å¼¦å‡½æ•°æ¥ç”Ÿæˆ $p_i$ çš„æ–¹æ³•ï¼Œå³ Sinusoidal ä½ç½®ç¼–ç ï¼š

$$p_{i,2t} = \sin\left(\frac{k}{10000^{2t/d}}\right) \\
p_{i,2t+1} = \cos\left(\frac{k}{10000^{2t/d}}\right) \tag{4}$$

å…¶ä¸­ï¼Œ $p_{i,2t}$ æ˜¯ $p_i$ çš„ç¬¬ $2t$ ä¸ªç»´åº¦ã€‚

Sinusoidal ä½ç½®ç¼–ç å…·æœ‰è¿œç¨‹è¡°å‡çš„æ€§è´¨ï¼Œå…·ä½“è¡¨ç°ä¸ºï¼šå¯¹äºä¸¤ä¸ªç›¸åŒçš„è¯å‘é‡ï¼Œå¦‚æœå®ƒä»¬ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼Œåˆ™ä»–ä»¬çš„å†…ç§¯åˆ†æ•°è¶Šé«˜ï¼Œåä¹‹åˆ™è¶Šä½ã€‚**è¿œç¨‹è¡°å‡**å¸¦æ¥çš„å½±å“æ˜¯ä½¿å¾—ä½ç½®ç¼–ç æ›´å€¾å‘äºæ•æ‰å±€éƒ¨ä¿¡æ¯ï¼Œé™åˆ¶äº†è¿œç¨‹äº¤äº’çš„å½±å“ã€‚è¿™ç§ç‰¹æ€§å¯¹çŸ­åºåˆ—æœ‰æ•ˆï¼Œä½†å¯¹é•¿åºåˆ—å¯èƒ½å—é™ï¼Œå³é€ æˆ Sinusoidal ä½ç½®ç¼–ç å¤–æ¨æ€§ä¸€èˆ¬ã€‚

<div align="center">
<img src="../images/positional_encoding/product.png" width="70%" alt="product">
</div>

## äºŒ æ—‹è½¬ä½ç½®ç¼–ç  RoPE

### 2.1 RoPE ç®—æ³•åŸç†

å¯¹äº RoPE è€Œè¨€ï¼Œä½œè€…çš„å‡ºå‘ç‚¹ä¸ºï¼š**é€šè¿‡ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°ç›¸å¯¹ä½ç½®ç¼–ç **ã€‚

[RoPE è®ºæ–‡](https://arxiv.org/pdf/2104.09864)æå‡ºä¸ºäº†èƒ½**åˆ©ç”¨ token ä¹‹é—´çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼ˆ$m-n$ï¼‰**ï¼Œå¸Œæœ› $q_m$ å’Œ $k$ ä¹‹é—´çš„å†…ç§¯ï¼Œå³ $f(q, m) \cdot f(k, n)$ ä¸­èƒ½å¤Ÿå¸¦æœ‰ç›¸å¯¹ä½ç½®ä¿¡æ¯ $m-n$ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ $f(q, m) \cdot f(k, n)$ çš„è®¡ç®—å¦‚ä½•æ‰ç®—å¸¦æœ‰ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œè®ºæ–‡æå‡ºåªéœ€å°†å…¶èƒ½å¤Ÿè¡¨ç¤ºæˆä¸€ä¸ªå…³äº $q$ã€$k$ ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ç›¸å¯¹ä½ç½® $m - n$ çš„å‡½æ•° $g(q, k, m - n)$ å³å¯ï¼Œå…¬å¼è¡¨è¾¾å¦‚ä¸‹æ‰€ç¤ºï¼š
 
$$\langle f_q(q, m), f_k(k, n) \rangle = g(q, k, m - n) \quad (5)$$

> æ³¨æ„ï¼Œè¿™é‡Œåªæœ‰ $f_q(q, m)$, $f_k(k, n)$ æ˜¯éœ€è¦æ±‚è§£çš„å‡½æ•°ï¼Œ$\langle  \rangle$ è¡¨ç¤ºå†…ç§¯æ“ä½œï¼Œè€Œå¯¹äº $g$ï¼Œæˆ‘ä»¬è¦æ±‚æ˜¯è¡¨è¾¾å¼ä¸­æœ‰ $q, k, (m-n)$ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ **$q_m, k$ çš„å†…ç§¯ä¼šå—ç›¸å¯¹ä½ç½® $m-n$ å½±å“**ã€‚

æ¥ä¸‹æ¥çš„ç›®æ ‡å°±æ˜¯**æ‰¾åˆ°ä¸€ä¸ªç­‰ä»·çš„ä½ç½®ç¼–ç æ–¹å¼ $f$ï¼Œä»è€Œä½¿å¾—ä¸Šè¿°å…³ç³»æˆç«‹**ï¼Œå‡½æ•° $f_q$ åŒ…å«äº†ä½ç½®ç¼–ç å’Œ $W_q \times q$ï¼ˆåµŒå…¥å‘é‡è½¬æ¢ä¸º $q$ å‘é‡ï¼‰è¿‡ç¨‹ã€‚

### 2.2 äºŒç»´ä½ç½®ç¼–ç 

å‡è®¾ç°åœ¨è¯åµŒå…¥å‘é‡çš„ç»´åº¦æ˜¯ä¸¤ç»´ $d=2$ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨ä¸Š $2$ ç»´åº¦å¹³é¢ä¸Šçš„å‘é‡çš„å‡ ä½•æ€§è´¨ï¼Œè®ºæ–‡ä½œè€…å€ŸåŠ©å¤æ•°æ¥è¿›è¡Œæ±‚è§£, æå‡ºäº†ä¸€ä¸ªæ»¡è¶³ä¸Šè¿°å…³ç³»çš„ $f$ å’Œ $g$ çš„å½¢å¼å¦‚ä¸‹:

$$f_q(x_m, m) = (W_q x_m) e^{im\theta} \\
f_k(x_n, n) = (W_k x_n) e^{in\theta} \\
g(x_m, x_n, m - n) = Re \left[ (W_q x_m)(W_k x_n)^* e^{i(m-n)\theta} \right] \quad (6)$$

> å…¶ä¸­ \( Re \) è¡¨ç¤ºå¤æ•°çš„å®éƒ¨ï¼Œ\( (W_k k)^* \) è¡¨ç¤º \( (W_k k) \) çš„å…±è½­å¤æ•°, $x_m$ è¡¨ç¤ºç¬¬ $m$ ä¸ª token å‘é‡ã€‚

$f_qã€f_k$ çš„æ¨å¯¼éœ€è¦åŸºäºä¸‰è§’å‡½æ•°å®šç†ã€æ¬§æ‹‰å…¬å¼ç­‰ï¼Œæ¨å¯¼è¿‡ç¨‹å‚è€ƒ[è¿™é‡Œ](https://zhuanlan.zhihu.com/p/642884818)ï¼Œæœ¬æ–‡ç›´æ¥ç»™å‡ºç»“è®ºï¼š

1ï¼Œ**$f_q(q, m)$ å…¶å®ç­‰äº `query` å‘é‡ä¹˜ä»¥äº†ä¸€ä¸ªæ—‹è½¬çŸ©é˜µ**ï¼Œå³:

$$f_q(q, m) = \begin{pmatrix} 
\cos(m\theta) & -\sin(m\theta) \\
\sin(m\theta) & \cos(m\theta)
\end{pmatrix}
\begin{pmatrix} 
q_m^{(1)} \\
q_m^{(2)} 
\end{pmatrix} \quad (7)$$

2ï¼Œ**$f_k(k, n)$ å…¶å®ç­‰äº `key` å‘é‡ä¹˜ä»¥äº†ä¸€ä¸ªæ—‹è½¬çŸ©é˜µ**ï¼Œå³:

$$f_k(k, n) = \begin{pmatrix} 
\cos(n\theta) & -\sin(n\theta) \\
\sin(n\theta) & \cos(n\theta)
\end{pmatrix}
\begin{pmatrix} 
k^{(1)} \\
k^{(2)} 
\end{pmatrix} \quad (8)$$

3ï¼ŒåŒæ ·å¯å¾— $g(q, k, m - n)$ ç­‰äº $q_m^T$ ä¹˜ä»¥æ—‹è½¬çŸ©é˜µå†ä¹˜ä»¥ $k$ï¼Œå³:

$$\langle f_q(q, m), f_k(k, n) \rangle  = \mathbf{q}_m^T R(m - n) \mathbf{k}_n \quad (9)$$

$$\begin{aligned}
g(q, k, m - n) &= (q_m^{(1)} k^{(1)} + q_m^{(2)} k^{(2)}) \cos((m - n)\theta) - (q_m^{(2)} k^{(1)} - q_m^{(1)} k^{(2)}) \sin((m - n)\theta) \\
&= \begin{pmatrix}
q_m^{(1)} & q_m^{(2)}
\end{pmatrix}
\begin{pmatrix}
\cos((m - n)\theta) & -\sin((m - n)\theta) \\
\sin((m - n)\theta) & \cos((m - n)\theta)
\end{pmatrix}
\begin{pmatrix}
k_n^{(1)} \\
k_n^{(2)}
\end{pmatrix} \\
 &= \mathbf{q}_m^T R(m - n) \mathbf{k}_n
\end{aligned} \quad(10)$$

å…¬å¼ï¼ˆ9ï¼‰çš„è¯æ˜ä¹Ÿå¯é€šè¿‡æ—‹è½¬çŸ©é˜µæ€§è´¨å¾—åˆ°ï¼Œå…ˆå°†å…¬å¼ (9) æŠ½è±¡æˆ $\langle R_a X, R_b Y \rangle = \langle X, R_{b-a} Y \rangle$ï¼ˆ$R$ è¡¨ç¤ºæ—‹è½¬çŸ©é˜µï¼Œ$Xã€Y$ è¡¨ç¤ºå‘é‡ï¼‰, è¯¥ç­‰å¼çš„è¯æ˜è¿‡ç¨‹å¦‚ä¸‹ï¼š


$$\begin{aligned}
\langle R_a X, R_b Y \rangle &= (R_aX)^T R_bY \\
&= X^T R_a^T R_bY \\
&=  X^T R(-a)R_bY \\
&=  X^T R_{(b-a)}Y = \langle X, R_{(b-a)}Y \rangle\\
\end{aligned} \quad(11)$$

ä¸Šè¿°æ¨å¯¼è¿‡ç¨‹åˆ†åˆ«åº”ç”¨äº†ï¼šå±•å¼€å†…ç§¯ã€çŸ©é˜µä¹˜æ³•çš„ç»“åˆå¾‹ã€æ—‹è½¬çŸ©é˜µæ€§è´¨1ã€æ—‹è½¬çŸ©é˜µæ€§è´¨2ã€‚

æ€»ç»“ï¼šå’Œæ­£å¼¦ä½ç½®ç¼–ç ä¸åŒï¼Œ**RoPE å¹¶ä¸æ˜¯ç›´æ¥å°†ä½ç½®ä¿¡æ¯ $p_i$ å’ŒåµŒå…¥å‘é‡å…ƒç´  $x_i$ ç›¸åŠ ï¼Œè€Œæ˜¯é€šè¿‡ä¸æ­£å¼¦å‡½æ•°ç›¸ä¹˜çš„æ–¹å¼å¼•å…¥ç›¸å¯¹ä½ç½®ä¿¡æ¯**ã€‚

### 2.3 å¤šç»´çš„ RoPE ç®—æ³•

å‰é¢çš„å…¬å¼æ¨å¯¼ï¼Œæ˜¯å‡è®¾çš„è¯åµŒå…¥ç»´åº¦æ˜¯ 2 ç»´å‘é‡ï¼Œå°†äºŒç»´æ¨å¹¿åˆ°ä»»æ„ç»´åº¦ï¼Œ$f_{\{q,k\}}$ å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š

$$f_{\{q,k\}}(q, m) = R_{\Theta, m}^d W_{\{q,k\}} q \tag{12}$$

å…¶ä¸­ï¼Œ$R_{\Theta, m}^d$ ä¸º $d$ ç»´åº¦çš„æ—‹è½¬çŸ©é˜µï¼Œè¡¨ç¤ºä¸ºï¼š

$$R_{\Theta, m}^d =
\begin{pmatrix}
\cos m\theta_0 & -\sin m\theta_0 & 0 & 0 & \cdots & 0 & 0 \\
\sin m\theta_0 & \cos m\theta_0 & 0 & 0 & \cdots & 0 & 0 \\
0 & 0 & \cos m\theta_1 & -\sin m\theta_1 & \cdots & 0 & 0 \\
0 & 0 & \sin m\theta_1 & \cos m\theta_1 & \cdots & 0 & 0 \\
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots & \vdots \\
0 & 0 & 0 & 0 & \cdots & \cos m\theta_{d/2-1} & -\sin m\theta_{d/2-1} \\
0 & 0 & 0 & 0 & \cdots & \sin m\theta_{d/2-1} & \cos m\theta_{d/2-1}
\end{pmatrix} \tag{13}$$

$R_{\Theta, m}^d$ çš„å½¢çŠ¶æ˜¯ `[sqe_len, dim//2]`ã€‚å¯ä»¥çœ‹å‡ºï¼Œå¯¹äº $d >= 2$ çš„é€šç”¨æƒ…å†µï¼Œåˆ™æ˜¯å°†è¯åµŒå…¥å‘é‡å…ƒç´ æŒ‰ç…§ä¸¤ä¸¤ä¸€ç»„åˆ†ç»„ï¼Œæ¯ç»„åº”ç”¨åŒæ ·çš„æ—‹è½¬æ“ä½œä¸”æ¯ç»„çš„æ—‹è½¬è§’åº¦è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š

$$
\Theta = \left\{ \theta_i = 10000^{-2(i-1)/d}, i \in [1, 2, \dots, d/2] \right\}
$$

å°† RoPE åº”ç”¨åˆ°å‰é¢å…¬å¼ï¼ˆ2ï¼‰çš„ Self-Attention è®¡ç®—ï¼Œå¯ä»¥å¾—åˆ°åŒ…å«ç›¸å¯¹ä½ç½®ä¿¡æ¯çš„Self-Attetionï¼š

$$q_m^T k = \left( R_{\Theta, m}^d W_q q \right)^T \left( R_{\Theta, n}^d W_k k \right) = q^T W_q R_{\Theta, n-m}^d W_k k \tag{14}$$

å…¶ä¸­ï¼Œ
$$R_{\Theta, n-m}^d = \left( R_{\Theta, m}^d \right)^T R_{\Theta, n}^d$$

Rotary Position Embedding(RoPE) å®ç°çš„å¯è§†åŒ–å¦‚ä¸‹å›¾æ‰€ç¤º:

<div align="center">
<img src="../images/rope/figure1.png" width="60%" alt="figure1">
</div>

æœ€åæ€»ç»“**ç»“åˆ RoPE çš„ self-attention æ“ä½œçš„æµç¨‹**å¦‚ä¸‹ï¼š
1. é¦–å…ˆï¼Œå¯¹äº `token` åºåˆ—ä¸­çš„æ¯ä¸ªè¯åµŒå…¥å‘é‡ï¼Œéƒ½è®¡ç®—å…¶å¯¹åº”çš„ query å’Œ key å‘é‡;
2. ç„¶ååœ¨å¾—åˆ° query å’Œ key å‘é‡çš„åŸºç¡€ä¸Šï¼Œåº”ç”¨å‰é¢ $f_q(q, m)$ å’Œ $f_k(k, n)$ çš„è®¡ç®—å…¬å¼ï¼ˆ7ï¼‰å’Œï¼ˆ8ï¼‰å¯¹æ¯ä¸ª `token` ä½ç½®éƒ½è®¡ç®—å¯¹åº”çš„æ—‹è½¬ä½ç½®ç¼–ç ï¼›
3. æ¥ç€å¯¹æ¯ä¸ª `token` ä½ç½®çš„ query å’Œ key å‘é‡çš„å…ƒç´ æŒ‰ç…§**ä¸¤ä¸¤ä¸€ç»„**åº”ç”¨æ—‹è½¬å˜æ¢ï¼›
4. æœ€åå†è®¡ç®— `query` å’Œ `key` ä¹‹é—´çš„å†…ç§¯å¾—åˆ° self-attention çš„è®¡ç®—ç»“æœã€‚

## ä¸‰ RoPE çš„ pytorch å®ç°

### 3.1 RoPE å®ç°æµç¨‹

å…ˆçœ‹æ—‹è½¬çŸ©é˜µç”¨äºæ—‹è½¬ä¸€ä¸ªäºŒç»´å‘é‡è¿‡ç¨‹ç¤ºä¾‹ï¼š

<div align="center">
<img src="../images/rope/rotation_matrix.png" width="60%" alt="2d_rotation_matrix_derivtion">
</div>

ä½†æ˜¯ Llama æ¨¡å‹çš„åµŒå…¥ç»´åº¦é«˜è¾¾ $4096$ï¼Œæ¯”äºŒç»´å¤æ‚å¾—å¤šï¼Œå¦‚ä½•åœ¨æ›´é«˜ç»´åº¦çš„åµŒå…¥ä¸Šåº”ç”¨æ—‹è½¬æ“ä½œå‘¢ï¼Ÿé€šè¿‡ RoPE ç®—æ³•åŸç†æˆ‘ä»¬çŸ¥é“ï¼Œ**åµŒå…¥å‘é‡çš„æ—‹è½¬å®é™…æ˜¯å°†æ¯ä¸ªåµŒå…¥å‘é‡å…ƒç´ ä½ç½® $m$ çš„å€¼ä¸æ¯ä¸€å¯¹åµŒå…¥ç»´åº¦å¯¹åº”çš„ $\theta$ ç›¸ä¹˜**ï¼Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
> RoPE é€šè¿‡å®ç°æ—‹è½¬çŸ©é˜µï¼Œ**æ˜¯æ—¢æ•è·ç»å¯¹ä½ç½®ä¿¡æ¯ï¼Œåˆç»“åˆç›¸å¯¹ä½ç½®ä¿¡æ¯çš„æ–¹å¼**ï¼ˆè®ºæ–‡å…¬å¼æœ‰æ›´è¯¦ç»†ä½“ç°ï¼‰ã€‚

<div align="center">
<img src="../images/rope/nd_rotation_matrix.png" width="60%" alt="nd_rotation_matrix_derivtion">
</div>

å›¾ä¸­æ¯ç»„çš„æ—‹è½¬è§’åº¦è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š

$$\Theta = \left\{ \theta_i = 10000^{-2(i-1)/d}, i \in [1, 2, \dots, d/2] \right\}$$

åœ¨å®ç° RoPE ç®—æ³•ä¹‹å‰ï¼Œéœ€è¦æ³¨æ„ï¼šä¸ºäº†æ–¹ä¾¿ä»£ç å®ç°ï¼Œåœ¨è¿›è¡Œæ—‹è½¬ä¹‹å‰ï¼Œéœ€è¦å°†æ—‹è½¬çŸ©é˜µè½¬æ¢ä¸ºæåæ ‡å½¢å¼ï¼ŒåµŒå…¥å‘é‡ï¼ˆ$q$ã€$k$ï¼‰éœ€è¦è½¬æ¢ä¸ºå¤æ•°å½¢å¼ã€‚å®Œæˆæ—‹è½¬åï¼Œæ—‹è½¬åçš„åµŒå…¥éœ€è¦è½¬æ¢å›å®æ•°å½¢å¼ï¼Œä»¥ä¾¿è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ã€‚æ­¤å¤–ï¼ŒRoPE ä»…åº”ç”¨äºæŸ¥è¯¢ï¼ˆQueryï¼‰å’Œé”®ï¼ˆKeyï¼‰çš„åµŒå…¥ï¼Œä¸é€‚ç”¨äºå€¼ï¼ˆValueï¼‰çš„åµŒå…¥ã€‚

### 3.2 RoPE çš„æ—‹è½¬çŸ©é˜µå®ç°

`Qwen3RotaryEmbedding` ç±»å¦‚ä¸‹æ‰€ç¤ºï¼Œ`forward` ç”¨äº**ç”Ÿæˆæ—‹è½¬çŸ©é˜µ** cos å’Œ sinã€‚

```python
class Qwen3RotaryEmbedding(nn.Module):
    """
    ç”¨äº Qwen-3 ç³»åˆ—æ¨¡å‹çš„æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRoPEï¼‰å¼ é‡æ„é€ å™¨ã€‚
    è¯¥æ¨¡å—åªè´Ÿè´£è®¡ç®— cos/sin ä¸¤å¼ æŸ¥è¡¨å¼ é‡ï¼Œä¾›åç»­ q,k å¼ é‡åšæ—‹è½¬ã€‚
    """
    def __init__(self, config: Qwen3Config, device: Optional[str] = None):
        super().__init__()
        
        # ---- â‘  è§£æ RoPE å­ç±»å‹ ----
        if hasattr(config, "rope_scaling") and config.rope_scaling is not None:
            self.rope_type = config.rope_scaling.get(
                "rope_type",  # æ–°å­—æ®µ
                config.rope_scaling.get("type", "default")  # æ—§å­—æ®µå…œåº•
            )
        else:
            self.rope_type = "default"  # è‹¥æ²¡é…ï¼Œåˆ™èµ°é»˜è®¤å®ç°

        # ---- â‘¡ è®°å½•æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆç¼“å­˜å¤§å°ï¼‰----
        self.max_seq_len_cached = config.max_position_embeddings
        self.original_max_seq_len = config.max_position_embeddings

        # ---- â‘¢ ä¿å­˜ config å¹¶é€‰æ‹©åˆå§‹åŒ–å‡½æ•° ----
        self.config = config
        self.rope_init_fn = ROPE_INIT_FUNCTIONS[self.rope_type]

        # ---- â‘£ ç”Ÿæˆ inv_freq ä¸ç¼©æ”¾å› å­ ----
        #   inv_freq shape: (head_dim//2,)ï¼Œå†…å®¹ä¸º 1/Î¸^i
        #   attention_scaling: é’ˆå¯¹éƒ¨åˆ† RoPE å˜ä½“çš„é¢å¤–ç¼©æ”¾
        inv_freq, self.attention_scaling = self.rope_init_fn(config, device)

        # æ³¨å†Œä¸º buffer â†’ ä¿å­˜åˆ° state_dictï¼Œä½†ä¸ç®—æ¨¡å‹å‚æ•°
        self.register_buffer("inv_freq", inv_freq, persistent=False)
        self.original_inv_freq = self.inv_freq  # å†å­˜ä¸€ä»½å¤‡ä»½ï¼Œä¾¿äºåŠ¨æ€æ‰©å±•
        head_dim = config.hidden_size // config.num_attention_heads
        # æ‰“å°åˆå§‹åŒ–ä¿¡æ¯
        print(f"ğŸ”§ åˆå§‹åŒ– RoPE ç¼–ç å™¨: ç±»å‹={self.rope_type}, æœ€å¤§ä½ç½®={self.max_seq_len_cached}")
        print(f"  å¤´ç»´åº¦={head_dim}, é¢‘ç‡å‚æ•°å½¢çŠ¶={inv_freq.shape}, ç¼©æ”¾å› å­={self.attention_scaling}")

    # --- å‰å‘è®¡ç®— ---
    @torch.no_grad()          # ä¸éœ€è¦æ¢¯åº¦
    @dynamic_rope_update      # é«˜é˜¶è£…é¥°å™¨ï¼šæ”¯æŒåœ¨çº¿æ‰©å±• RoPE é•¿åº¦
    def forward(self, x: torch.Tensor, position_ids: torch.Tensor):
        """
        å‚æ•°
        ----
        x:            (bs, seq, hidden_size) åªæ˜¯ç”¨æ¥æ‹¿ dtype/device
        position_ids: (bs, seq)              æ¯ä¸ª token çš„ç»å¯¹ä½ç½®
        
        è¿”å›
        ----
        cos, sin: äºŒå¼ æŸ¥è¡¨å¼ é‡ï¼Œshape=(bs, seq, head_dim)
        """
        # 0. è®¾å¤‡å¤„ç†ï¼ˆç¡®ä¿åœ¨æ­£ç¡®è®¾å¤‡ä¸Šï¼‰
        device = x.device
        
        # 1. å°† inv_freq å°ºå¯¸ [head_dim//2] æ‰©å±•åˆ° (bs, head_dim//2, 1)
        inv_freq_expanded = (self.inv_freq[None, :, None]  # [1, head_dim//2, 1]
                            .float()                      # ç¡®ä¿fp32ç²¾åº¦
                            .expand(position_ids.shape[0], -1, 1)  # [bs, head_dim//2, 1]
                            .to(device)) # ç¡®ä¿å¼ é‡ä½äºæ­£ç¡®çš„è®¡ç®—è®¾å¤‡ä¸Šï¼ˆCPUæˆ–GPUï¼‰
        print("ã€é¢‘ç‡å› å­ã€‘inv_freq shape:", inv_freq_expanded.shape)
        print("ã€æ‹“å±•åçš„é¢‘ç‡å› å­ã€‘inv_freq_expanded shape:", inv_freq_expanded.shape)

        # 2. å°† position_ids (bs, seq) æ‰©å±•åˆ° (bs, 1, seq)
        position_ids_expanded = position_ids[:, None, :].float()  # [bs, 1, seq]

        # 3. æŒ‡å®š autocast çš„è®¾å¤‡ç±»å‹ï¼ˆMPS ä¾‹å¤–éœ€é€€å› cpuï¼‰
        device_type = "cpu" if device.type == "mps" else device.type

        # 4. å¼ºåˆ¶ç¦ç”¨ autocast â†’ ç”¨ fp32 è®¡ç®—è§’åº¦ï¼Œé˜²æ­¢ç²¾åº¦æŸå¤±
        with torch.autocast(device_type=device_type, enabled=False):
            # çŸ©é˜µä¹˜æ³•: [bs, head_dim//2, 1] @ (bs, 1, seq) â†’ (bs, head_dim//2, seq)
            # ç»“æœ freqs å¼ é‡åŒ…å«äº†ç”¨äºåç»­sin/cosè®¡ç®—çš„è§’åº¦å€¼ã€‚
            freqs = torch.matmul(inv_freq_expanded, position_ids_expanded)
            
            # è½¬ç½®: (bs, head_dim//2, seq) â†’ (bs, seq, head_dim//2)
            freqs = freqs.transpose(1, 2)
            
            # æ‹¼æ¥å¶ã€å¥‡ç»´åº¦ â†’ (bs, seq, head_dim)
            emb = torch.cat((freqs, freqs), dim=-1)

            # å– cos / sinï¼ˆå†ä¹˜å¯é€‰ scalingï¼‰
            cos = emb.cos() * self.attention_scaling
            sin = emb.sin() * self.attention_scaling

        # 5. ä¸è¾“å…¥å¼ é‡ä¿æŒä¸€è‡´çš„ dtype è¿”å›
        return cos.to(dtype=x.dtype), sin.to(dtype=x.dtype)
```

`forward` å‡½æ•°çš„è®¡ç®—æµç¨‹å¯è§†åŒ–å¦‚ä¸‹æ‰€ç¤º:

```mermaid
graph TD
    A[inv_freq] -->|æ‰©å±•ç»´åº¦| B[inv_freq_expanded<br>2Ã—2Ã—1]
    C[position_ids] -->|æ‰©å±•ç»´åº¦| D[position_ids_expanded<br>2Ã—1Ã—3]
    B -->|çŸ©é˜µä¹˜æ³•| E[freqs<br>2Ã—2Ã—3]
    D -->|çŸ©é˜µä¹˜æ³•| E
    E -->|è½¬ç½®| F[freqs_transposed<br>2Ã—3Ã—2]
    F -->|å¤åˆ¶æ‹¼æ¥| G[emb<br>2Ã—3Ã—4]
    G -->|cosè¿ç®—| H[cos<br>2Ã—3Ã—4]
    G -->|sinè¿ç®—| I[sin<br>2Ã—3Ã—4]
```

<div align="center">
<img src="../images/rope/rotary_emb.jpg" width="45%" alt="rotary_emb">
</div>

`concat` æ‹¼æ¥æ“ä½œçš„æ„ä¹‰ä½“ç°äº† RoPE çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼šæ¯ä¸ªé¢‘ç‡åˆ†é‡ä¼šåŒæ—¶ç”¨äºç”Ÿæˆ cos å’Œ sin å€¼ï¼Œç”¨äºå¯¹åº”çš„å¶æ•°å’Œå¥‡æ•°ç»´åº¦ä½ç½®ã€‚

ä¸Šè¿° Qwen3RotaryEmbedding ç±»çš„æµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```python
import torch
import torch.nn as nn
from typing import Optional, Tuple
import numpy as np

# å®šä¹‰è£…é¥°å™¨ï¼ˆå¦‚æœæ²¡æœ‰åŠ¨æ€æ›´æ–°éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ç©ºè£…é¥°å™¨ï¼‰
def dynamic_rope_update(func):
    return func

# å®šä¹‰RoPEåˆå§‹åŒ–å‡½æ•°å­—å…¸
ROPE_INIT_FUNCTIONS = {
    "default": lambda config, device: default_rope_init(config, device),
    # æ·»åŠ å…¶ä»–åˆå§‹åŒ–ç±»å‹...
}

def default_rope_init(config, device) -> Tuple[torch.Tensor, float]:
    """é»˜è®¤RoPEåˆå§‹åŒ–å‡½æ•°"""
    # è®¡ç®—æ¯ä¸ªå¤´çš„ç»´åº¦
    head_dim = config.hidden_size // config.num_attention_heads
    
    # è®¡ç®—åŸºç¡€é¢‘ç‡
    base = getattr(config, "rope_theta", 10000.0)
    inv_freq = 1.0 / (base ** (torch.arange(0, head_dim, 2, device=device).float() / head_dim))
    
    # é»˜è®¤ç¼©æ”¾å› å­ä¸º1.0
    attention_scaling = 1.0
    return inv_freq, attention_scaling

# ç®€åŒ–çš„é…ç½®ç±»
class Qwen3Config:
    def __init__(self, rope_scaling=None, max_position_embeddings=4096, 
                 hidden_size=4096, num_attention_heads=32, rope_theta=10000.0):
        self.rope_scaling = rope_scaling
        self.max_position_embeddings = max_position_embeddings
        self.hidden_size = hidden_size
        self.num_attention_heads = num_attention_heads
        self.rope_theta = rope_theta

# ===== å¢å¼ºç‰ˆæµ‹è¯•å‡½æ•° =====
def test_rotary_embedding(visualize: bool = True):
    """å…¨é¢æµ‹è¯• RoPE å®ç°å¹¶è¾“å‡ºè¯¦ç»†åˆ†æ"""
    print("\n" + "="*60)
    print("ğŸ”¥ Qwen-3 RoPE æ—‹è½¬ä½ç½®ç¼–ç  å…¨é¢æµ‹è¯•")
    print("="*60)
    
    # é…ç½®å‚æ•°
    bs, seq, n_heads, head_dim = 2, 16, 32, 128
    hidden_size = n_heads * head_dim
    
    print(f"\nğŸ“‹ æµ‹è¯•é…ç½®:")
    print(f"  æ‰¹å¤§å° (bs) = {bs}")
    print(f"  åºåˆ—é•¿åº¦ (seq) = {seq}")
    print(f"  æ³¨æ„åŠ›å¤´æ•° (n_heads) = {n_heads}")
    print(f"  æ¯ä¸ªå¤´çš„ç»´åº¦ (head_dim) = {head_dim}")
    print(f"  æ€»éšè—å¤§å° (hidden_size) = {hidden_size}")
    
    # åˆ›å»ºé…ç½®å¯¹è±¡
    dummy_cfg = Qwen3Config(
        rope_scaling={"rope_type": "default"},
        max_position_embeddings=4096,
        hidden_size=hidden_size,
        num_attention_heads=n_heads,
        rope_theta=10000.0
    )

    # åˆ›å»ºRoPEæ¨¡å—
    print("\nğŸ›  åˆ›å»º RoPE ç¼–ç å™¨...")
    rot = Qwen3RotaryEmbedding(dummy_cfg, device="cpu")
    
    # æ‰“å°é¢‘ç‡å‚æ•°ä¿¡æ¯
    inv_freq = rot.inv_freq.cpu().numpy()
    print(f"\nğŸ“Š é¢‘ç‡å‚æ•°åˆ†æ (inv_freq):")
    print(f"  å½¢çŠ¶: {inv_freq.shape}")
    print(f"  æœ€å°å€¼: {inv_freq.min():.6f}")
    print(f"  æœ€å¤§å€¼: {inv_freq.max():.6f}")
    print(f"  å¹³å‡å€¼: {inv_freq.mean():.6f}")
    print(f"  å‰5ä¸ªå€¼: {inv_freq[:5].round(6)}")
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    x = torch.randn(bs, seq, hidden_size)  # æ¨¡æ‹Ÿè¾“å…¥
    position_ids = torch.arange(seq).repeat(bs, 1)  # (bs, seq)
    
    print("\nâš¡ è®¡ç®— RoPE ç¼–ç ...")
    cos, sin = rot(x, position_ids)
    
    # éªŒè¯è¾“å‡º
    print("\nâœ… è¾“å‡ºéªŒè¯:")
    print(f"  cos å½¢çŠ¶: {cos.shape} â†’ (æ‰¹å¤§å°, åºåˆ—é•¿åº¦, head_dim)")
    print(f"  sin å½¢çŠ¶: {sin.shape}")
    
    # éªŒè¯ä¸‰è§’å‡½æ•°æ€§è´¨
    cos_sin_sum = cos**2 + sin**2
    error = (cos_sin_sum - 1).abs().max()
    print(f"\nğŸ” æ•°å­¦æ€§è´¨éªŒè¯ (cosÂ²Î¸ + sinÂ²Î¸ = 1):")
    print(f"  æœ€å¤§è¯¯å·®: {error.item():.3e}")
    print(f"  æ˜¯å¦æ¥è¿‘1 (è¯¯å·® < 1e-6): {'æ˜¯' if error < 1e-6 else 'å¦'}")

    # åˆ†æä½ç½®å·®å¼‚
    print("\nğŸŒ ä½ç½®ç¼–ç å·®å¼‚åˆ†æ:")
    for pos_diff in [0, 1, 4, 8]:
        # è®¡ç®—ä½ç½®å·®ä¸ºpos_diffæ—¶çš„ç‚¹ç§¯
        dot_products = []
        for i in range(0, seq - pos_diff):
            q = cos[0, i] * sin[0, i + pos_diff] - sin[0, i] * cos[0, i + pos_diff]
            dot_products.append(q.mean().item())
        
        avg_dot = np.mean(dot_products)
        print(f"  ä½ç½®å·® {pos_diff:2d}: å¹³å‡ç‚¹ç§¯ = {avg_dot:.4f}")

    # å¯è§†åŒ–éƒ¨åˆ†
    if visualize:
        try:
            import matplotlib.pyplot as plt
            # 1. é¢‘ç‡å‚æ•°å¯è§†åŒ–
            plt.figure(figsize=(12, 10))
            
            # é¢‘ç‡å‚æ•°
            plt.subplot(2, 1, 1)
            plt.plot(inv_freq, 'o-', markersize=3)
            plt.title("RoPE Frequency Parameters (inv_freq)")
            plt.xlabel("Dimension Index")
            plt.ylabel("Frequency Value")
            plt.grid(True)
            
            # 2. ä¸åŒä½ç½®çš„è§’åº¦å˜åŒ–
            plt.subplot(2, 1, 2)
            positions_to_plot = [0, 1, 4, 8]
            dims_to_plot = min(32, head_dim)
            
            # å–ç¬¬ä¸€ä¸ªbatchçš„ä¸åŒä½ç½®
            for pos in positions_to_plot:
                # è®¡ç®—è§’åº¦ (Î¸ = position * inv_freq)
                angles = (position_ids[0, pos] * rot.inv_freq).cpu().numpy()
                plt.plot(angles[:dims_to_plot], label=f"Position {pos}")
            
            plt.title(f"Angle Values for First {dims_to_plot} Dimensions")
            plt.xlabel("Dimension Index")
            plt.ylabel("Angle (radians)")
            plt.legend()
            plt.grid(True)
            plt.tight_layout()
            plt.savefig("rope_analysis.png")
            print("\nğŸ“ˆ å¯è§†åŒ–å·²ä¿å­˜è‡³ rope_analysis.png")
            
            # 3. ä½ç½®å·®å¼‚çƒ­åŠ›å›¾
            plt.figure(figsize=(10, 8))
            max_pos = 10  # åªæ˜¾ç¤ºå‰10ä¸ªä½ç½®
            
            # è®¡ç®—ç›¸å¯¹ä½ç½®ç¼–ç çš„å·®å¼‚
            position_diff = np.zeros((max_pos, max_pos))
            for i in range(max_pos):
                for j in range(max_pos):
                    # è®¡ç®—ç‚¹ç§¯ä½œä¸ºç›¸ä¼¼åº¦
                    sim = (cos[0, i] * cos[0, j] + sin[0, i] * sin[0, j]).mean().item()
                    position_diff[i, j] = sim
            
            plt.imshow(position_diff, cmap='viridis', origin='lower')
            plt.colorbar(label='Position Similarity')
            plt.title("Position Encoding Similarity Heatmap")
            plt.xlabel("Position j")
            plt.ylabel("Position i")
            plt.xticks(range(max_pos))
            plt.yticks(range(max_pos))
            plt.savefig("position_similarity.png")
            print("ğŸ“Š ä½ç½®ç›¸ä¼¼åº¦çƒ­åŠ›å›¾å·²ä¿å­˜è‡³ position_similarity.png")
            
        except ImportError:
            print("\nâš  æ— æ³•å¯¼å…¥ matplotlibï¼Œè·³è¿‡å¯è§†åŒ–éƒ¨åˆ†")
    
    print("\nğŸ‰ æµ‹è¯•å®Œæˆ!")

# æ‰§è¡Œæµ‹è¯•
if __name__ == "__main__":
    test_rotary_embedding(visualize=True)
```

ä¸Šè¿°ç¨‹åºè¿è¡Œåè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º:

```bash
============================================================
ğŸ”¥ Qwen-3 RoPE æ—‹è½¬ä½ç½®ç¼–ç  å…¨é¢æµ‹è¯•
============================================================

ğŸ“‹ æµ‹è¯•é…ç½®:
  æ‰¹å¤§å° (bs) = 2
  åºåˆ—é•¿åº¦ (seq) = 16
  æ³¨æ„åŠ›å¤´æ•° (n_heads) = 32
  æ¯ä¸ªå¤´çš„ç»´åº¦ (head_dim) = 128
  æ€»éšè—å¤§å° (hidden_size) = 4096

ğŸ›  åˆ›å»º RoPE ç¼–ç å™¨...
ğŸ”§ åˆå§‹åŒ– RoPE ç¼–ç å™¨: ç±»å‹=default, æœ€å¤§ä½ç½®=4096
  å¤´ç»´åº¦=128, é¢‘ç‡å‚æ•°å½¢çŠ¶=torch.Size([64]), ç¼©æ”¾å› å­=1.0

ğŸ“Š é¢‘ç‡å‚æ•°åˆ†æ (inv_freq):
  å½¢çŠ¶: (64,)
  æœ€å°å€¼: 0.000115
  æœ€å¤§å€¼: 1.000000
  å¹³å‡å€¼: 0.116562
  å‰5ä¸ªå€¼: [1.       0.865964 0.749894 0.649382 0.562341]

âš¡ è®¡ç®— RoPE ç¼–ç ...
inv_freq_expanded shape: torch.Size([2, 64, 1])

âœ… è¾“å‡ºéªŒè¯:
  cos å½¢çŠ¶: torch.Size([2, 16, 128]) â†’ (æ‰¹å¤§å°, åºåˆ—é•¿åº¦, head_dim)
  sin å½¢çŠ¶: torch.Size([2, 16, 128])

ğŸ” æ•°å­¦æ€§è´¨éªŒè¯ (cosÂ²Î¸ + sinÂ²Î¸ = 1):
  æœ€å¤§è¯¯å·®: 1.192e-07
  æ˜¯å¦æ¥è¿‘1 (è¯¯å·® < 1e-6): æ˜¯

ğŸŒ ä½ç½®ç¼–ç å·®å¼‚åˆ†æ:
  ä½ç½®å·®  0: å¹³å‡ç‚¹ç§¯ = 0.0000
  ä½ç½®å·®  1: å¹³å‡ç‚¹ç§¯ = 0.1094
  ä½ç½®å·®  4: å¹³å‡ç‚¹ç§¯ = 0.1844
  ä½ç½®å·®  8: å¹³å‡ç‚¹ç§¯ = 0.1783

ğŸ“ˆ å¯è§†åŒ–å·²ä¿å­˜è‡³ rope_analysis.png
ğŸ“Š ä½ç½®ç›¸ä¼¼åº¦çƒ­åŠ›å›¾å·²ä¿å­˜è‡³ position_similarity.png
```

![rope_analysis](../images/rope/rope_analysis.png)

RoPE Frequency Parameters è§£é‡Š:

- Xè½´: Dimension Index (ç»´åº¦ç´¢å¼•)
- Yè½´: Frequency Value (é¢‘ç‡å€¼)

å±•ç¤ºé¢‘ç‡å‚æ•°éšç»´åº¦ç´¢å¼•çš„å˜åŒ–

- Angle Values for First N Dimensions:
- Xè½´: Dimension Index (ç»´åº¦ç´¢å¼•)
- Yè½´: Angle (radians) (è§’åº¦å€¼ï¼Œå¼§åº¦)
- ä¸åŒé¢œè‰²ä»£è¡¨ä¸åŒä½ç½®(0,1,4,8)åœ¨å„ç»´åº¦çš„è§’åº¦å€¼

### 3.3 apply_rotary_pos_emb å®ç°

#### å‡½æ•° f å®ç°æ‹†è§£

å¾—åˆ°æ—‹è½¬çŸ©é˜µåï¼Œå†åº”ç”¨æ—‹è½¬çŸ©é˜µä½ç½®ç¼–ç ï¼Œå¾—åˆ°é›†æˆäº†ç›¸å¯¹ä½ç½®ä¿¡æ¯çš„ $q$ å’Œ $k$ï¼Œæ ¸å¿ƒå…¬å¼æ‹†è§£åˆ†æå¦‚ä¸‹ã€‚

RoPE çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æ—‹è½¬æ“ä½œå°†ä½ç½®ä¿¡æ¯ç¼–ç åˆ°æŸ¥è¯¢å’Œé”®å‘é‡ä¸­ã€‚å¯¹äºä½ç½® $m$ çš„æŸ¥è¯¢å‘é‡ $q_m$ å’Œä½ç½® $n$ çš„é”®å‘é‡ $k_n$ï¼Œæ—‹è½¬åçš„å‘é‡ä¸ºï¼š

$$\tilde{q}_m = R_m q_m \\
\tilde{k}_n = R_n k_n$$

å…¶ä¸­ $R_m$ å’Œ $R_n$ æ˜¯ä½ç½®ç›¸å…³çš„æ—‹è½¬çŸ©é˜µã€‚æ—‹è½¬åï¼Œç‚¹ç§¯ç»“æœä»…ä¾èµ–äºç›¸å¯¹ä½ç½® (m-n)ï¼š

$$\tilde{q}_m^T \tilde{k}_n = (R_m q_m)^T (R_n k_n) = q_m^T R_m^T R_n k_n = q_m^T R_{m-n} k_n$$

ä»£ç å®ç°é€æ­¥åˆ†æï¼š

```python
def rotate_half(x):
    """Rotates half the hidden dims of the input."""
    # å°†æœ€åä¸€ä¸ªç»´åº¦ä¸€åˆ†ä¸ºäºŒ
    x1 = x[..., : x.shape[-1] // 2]
    x2 = x[..., x.shape[-1] // 2 :]
    # æ‹¼æ¥ -x2 ä¸ x1
    return torch.cat((-x2, x1), dim=-1)
```

ä¸Šè¿°å‡½æ•°å®ç°äº†äºŒç»´æ—‹è½¬çŸ©é˜µçš„æ ¸å¿ƒæ“ä½œã€‚åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œæ—‹è½¬çŸ©é˜µä¸ºï¼š

$$R(\theta) = \begin{bmatrix}
\cos \theta & -\sin \theta \\
\sin \theta & \cos \theta
\end{bmatrix}$$

å½“åº”ç”¨äºå‘é‡ $[x, y]$ æ—¶ï¼š

$$R(\theta) \begin{bmatrix} x \\ y \end{bmatrix} = 
\begin{bmatrix}
x \cos \theta - y \sin \theta \\
x \sin \theta + y \cos \theta
\end{bmatrix}$$

rotate_half å‡½æ•°è®¡ç®—äº†æ—‹è½¬æ“ä½œçš„ä¸€éƒ¨åˆ†ï¼š$-y$ å’Œ $x$ï¼Œå¯¹åº”æ—‹è½¬çŸ©é˜µçš„ç¬¬äºŒåˆ—ã€‚

`apply_rotary_pos_emb` çš„ pytorch ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```python
def apply_rotary_pos_emb(q, k, cos, sin, position_ids=None, unsqueeze_dim=1):
    # è°ƒæ•´ cos/sin å½¢çŠ¶ä»¥åŒ¹é… q/k çš„ç»´åº¦
    cos = cos.unsqueeze(unsqueeze_dim)  # æ·»åŠ æ–°ç»´åº¦
    sin = sin.unsqueeze(unsqueeze_dim)  # æ·»åŠ æ–°ç»´åº¦
    
    # åº”ç”¨æ—‹è½¬ä½ç½®åµŒå…¥åˆ°æŸ¥è¯¢å‘é‡
    q_embed = (q * cos) + (rotate_half(q) * sin)
    
    # åº”ç”¨æ—‹è½¬ä½ç½®åµŒå…¥åˆ°é”®å‘é‡
    k_embed = (k * cos) + (rotate_half(k) * sin)
    
    return q_embed, k_embed
```

å‡½æ•°å®ç°äº†å®Œæ•´çš„æ—‹è½¬æ“ä½œï¼š

$$\tilde{q}_m = q_m \odot \cos(m\theta) + \text{rotate\_half}(q_m) \odot \sin(m\theta)$$

å…¶ä¸­ï¼š

- `q * cos` å¯¹åº”æ—‹è½¬çŸ©é˜µçš„ç¬¬ä¸€åˆ—æ“ä½œï¼š$x \cdot cos \theta$
- `rotate_half(q) * sin` å¯¹åº”æ—‹è½¬çŸ©é˜µçš„ç¬¬äºŒåˆ—æ“ä½œï¼š$(-y sin \theta, x sin \theta)$

å½“ä¸¤è€…ç›¸åŠ æ—¶ï¼Œå°±å®Œæˆäº†å®Œæ•´çš„æ—‹è½¬æ“ä½œï¼š

$$\begin{bmatrix}
x \cos \theta - y \sin \theta \\
x \sin \theta + y \cos \theta
\end{bmatrix} = 
\begin{bmatrix}
x \\
y
\end{bmatrix} \cos \theta + 
\begin{bmatrix}
-y \\
x
\end{bmatrix} \sin \theta$$

RoPE å°†é«˜ç»´ç©ºé—´åˆ†è§£ä¸ºå¤šä¸ªäºŒç»´å­ç©ºé—´ï¼Œåœ¨æ¯ä¸ªå­ç©ºé—´ä¸Šç‹¬ç«‹åº”ç”¨æ—‹è½¬ï¼š

$$R_{\Theta,m}^d = 
\begin{pmatrix}
\cos m\theta_1 & -\sin m\theta_1 & 0 & \cdots & 0 \\
\sin m\theta_1 & \cos m\theta_1 & 0 & \cdots & 0 \\
0 & 0 & \cos m\theta_2 & -\sin m\theta_2 & \cdots \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 0 & \cdots & \cos m\theta_{d/2} & -\sin m\theta_{d/2} \\
0 & 0 & \cdots & \sin m\theta_{d/2} & \cos m\theta_{d/2}
\end{pmatrix}$$

#### æ€»ç»“

ä»£ç ä¸­é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°è¿™ç§åˆ†ç»„å¤„ç†ï¼š

1. rotate_half å‡½æ•°å°†è¾“å…¥å‘é‡åˆ†ä¸ºå‰åä¸¤åŠ
2. å¯¹æ¯ä¸ªäºŒç»´å­ç©ºé—´åº”ç”¨ç›¸åŒçš„æ—‹è½¬å…¬å¼
3. ä¸åŒå­ç©ºé—´ä½¿ç”¨ä¸åŒçš„æ—‹è½¬é¢‘ç‡ $\theta_i$

#### æµ‹è¯•ä»£ç 

`apply_rotary_pos_emb` æµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```python
import torch, math
import numpy as np

def rotate_half(x):
    """æ—‹è½¬è¾“å…¥çš„ä¸€åŠéšè—ç»´åº¦"""
    x1 = x[..., : x.shape[-1] // 2]
    x2 = x[..., x.shape[-1] // 2 :]
    return torch.cat((-x2, x1), dim=-1)

def apply_rotary_pos_emb(q, k, cos, sin, position_ids=None, unsqueeze_dim=1):
    cos = cos.unsqueeze(unsqueeze_dim)
    sin = sin.unsqueeze(unsqueeze_dim)
    q_embed = (q * cos) + (rotate_half(q) * sin)
    k_embed = (k * cos) + (rotate_half(k) * sin)
    return q_embed, k_embed

def test_apply_rotary_pos_emb():
    """å…¨é¢æµ‹è¯• RoPE åº”ç”¨å‡½æ•°å¹¶è¾“å‡ºè¯¦ç»†åˆ†æ"""
    print("\n" + "="*90)
    print("ğŸ”¥ æ—‹è½¬ä½ç½®ç¼–ç (RoPE)åº”ç”¨å‡½æ•° - å…¨é¢æµ‹è¯•")
    print("="*90)
    
    # æµ‹è¯•é…ç½®
    batch_size, seq_len, num_heads, head_dim = 2, 16, 32, 128
    total_params = batch_size * num_heads * seq_len * head_dim * 2
    
    print("\nğŸ“‹ æµ‹è¯•é…ç½®:")
    print(f"  æ‰¹å¤§å°: {batch_size}")
    print(f"  åºåˆ—é•¿åº¦: {seq_len}")
    print(f"  æ³¨æ„åŠ›å¤´æ•°é‡: {num_heads}")
    print(f"  å¤´ç»´åº¦: {head_dim}")
    print(f"  å¤„ç†å‚æ•°æ€»é‡: {total_params:,} (â‰ˆ{total_params/1e6:.1f}M)")
    print(f"  ä½¿ç”¨ RoPE å®ç°: {apply_rotary_pos_emb.__name__}")
    
    # åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
    torch.manual_seed(42)
    
    print("\nğŸ”§ åˆ›å»ºæµ‹è¯•æ•°æ®...")
    q = torch.randn(batch_size, num_heads, seq_len, head_dim)
    k = torch.randn(batch_size, num_heads, seq_len, head_dim)
    
    print("\nğŸ“ æ—‹è½¬å‰å¼ é‡å½¢çŠ¶éªŒè¯:")
    print(f"  q å½¢çŠ¶: {q.shape} [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")
    print(f"  k å½¢çŠ¶: {k.shape} [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")

    # ä¿®å¤åŸå§‹æŸ¥è¯¢å‘é‡æ˜¾ç¤ºé—®é¢˜ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç´¢å¼•
    print("\nğŸ” åŸå§‹æŸ¥è¯¢å‘é‡ (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=0):")
    print(f"  å½¢çŠ¶: {q[0, 0, 0].shape}")
    print(f"  å‰10ä¸ªå…ƒç´ : {q[0, 0, 0][:10].numpy().round(4)}")
    print(f"  èŒƒæ•°: {torch.norm(q[0, 0, 0]).item():.4f}")
    
    # æ˜¾ç¤ºä¸åŒä½ç½®çš„å‘é‡ä»¥å¢å¼ºå¯è§‚å¯Ÿæ€§
    print("\nğŸ” åŸå§‹æŸ¥è¯¢å‘é‡ (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=15):")
    print(f"  å‰10ä¸ªå…ƒç´ : {q[0, 0, 15][:10].numpy().round(4)}")
    print(f"  èŒƒæ•°: {torch.norm(q[0, 0, 15]).item():.4f}")
    
    # åˆ›å»ºä½ç½®ç¼–ç 
    print("\nâš™ï¸ ç”Ÿæˆä½ç½®ç¼–ç ...")
    cos = torch.zeros(batch_size, seq_len, head_dim)
    sin = torch.zeros(batch_size, seq_len, head_dim)
    
    print("\n  ä½ç½®ç¼–ç ï¼ˆæ—‹è½¬çŸ©é˜µï¼‰å½¢çŠ¶éªŒè¯:")
    print(f"  cos å½¢çŠ¶: {cos.shape} [æ‰¹å¤§å°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")
    print(f"  sin å½¢çŠ¶: {sin.shape} [æ‰¹å¤§å°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")

    for b in range(batch_size):
        for pos in range(seq_len):
            angle = pos * 0.1
            for d in range(head_dim):
                freq = 0.5 ** (d // 2)
                cos[b, pos, d] = math.cos(angle * freq)
                sin[b, pos, d] = math.sin(angle * freq)
    
    print("\nğŸ“Š ä½ç½®ç¼–ç ç¤ºä¾‹:")
    print("  æ‰¹æ¬¡=0, ä½ç½®=0:")
    print(f"    cos[:10]: {cos[0, 0, :10].numpy().round(4)}")
    print(f"    sin[:10]: {sin[0, 0, :10].numpy().round(4)}")
    
    print("  æ‰¹æ¬¡=0, ä½ç½®=1:")
    print(f"    cos[:10]: {cos[0, 1, :10].numpy().round(4)}")
    print(f"    sin[:10]: {sin[0, 1, :10].numpy().round(4)}")
    
    # åº”ç”¨æ—‹è½¬ä½ç½®åµŒå…¥
    print("\nâš¡ åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç ...")
    q_rot, k_rot = apply_rotary_pos_emb(q, k, cos, sin, unsqueeze_dim=1)
    print("  âœ… æ—‹è½¬åº”ç”¨æˆåŠŸ")
    
    # å¢åŠ  q_embed å’Œ k_embed å½¢çŠ¶æ‰“å°
    print("\nğŸ“ æ—‹è½¬åå¼ é‡å½¢çŠ¶éªŒè¯:")
    print(f"  q_embed å½¢çŠ¶: {q_rot.shape} [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")
    print(f"  k_embed å½¢çŠ¶: {k_rot.shape} [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]")

    # éªŒè¯è¾“å‡ºå½¢çŠ¶
    print("\nâœ… è¾“å‡ºéªŒè¯:")
    print(f"  æ—‹è½¬åæŸ¥è¯¢å‘é‡å½¢çŠ¶: {q_rot.shape} (åº”ä¸è¾“å…¥ç›¸åŒ)")
    print(f"  æ—‹è½¬åé”®å‘é‡å½¢çŠ¶: {k_rot.shape}")
    
    # å¢å¼ºçš„æ—‹è½¬å‰åå¯¹æ¯”
    print("\nğŸ”„ æ—‹è½¬å‰åå¯¹æ¯” (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=0):")
    print("  åŸå§‹å‘é‡:")
    print(f"    å‰10ä¸ªå…ƒç´ : {q[0, 0, 0][:10].numpy().round(4)}")
    print(f"    èŒƒæ•°: {torch.norm(q[0, 0, 0]).item():.4f}")
    
    print("  æ—‹è½¬åå‘é‡:")
    print(f"    å‰10ä¸ªå…ƒç´ : {q_rot[0, 0, 0][:10].numpy().round(4)}")
    print(f"    èŒƒæ•°: {torch.norm(q_rot[0, 0, 0]).item():.4f}")
    
    print("\nğŸ”„ æ—‹è½¬å‰åå¯¹æ¯” (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=15):")
    print("  åŸå§‹å‘é‡:")
    print(f"    å‰10ä¸ªå…ƒç´ : {q[0, 0, 15][:10].numpy().round(4)}")
    print(f"    èŒƒæ•°: {torch.norm(q[0, 0, 15]).item():.4f}")
    
    print("  æ—‹è½¬åå‘é‡:")
    print(f"    å‰10ä¸ªå…ƒç´ : {q_rot[0, 0, 15][:10].numpy().round(4)}")
    print(f"    èŒƒæ•°: {torch.norm(q_rot[0, 0, 15]).item():.4f}")
    
    # éªŒè¯æ¨¡é•¿ä¸å˜æ€§
    print("\nğŸ” èŒƒæ•°ä¿æŒéªŒè¯:")
    max_diff = 0.0
    for b in range(batch_size):
        for h in range(num_heads):
            for pos in range(seq_len):
                orig_norm = torch.norm(q[b, h, pos]).item()
                rot_norm = torch.norm(q_rot[b, h, pos]).item()
                diff = abs(orig_norm - rot_norm)
                max_diff = max(max_diff, diff)
    
    print(f"  æœ€å¤§èŒƒæ•°å·®å¼‚: {max_diff:.6f}")
    if max_diff < 1e-5:
        print("  âœ… é€šè¿‡: æ‰€æœ‰å‘é‡èŒƒæ•°ä¿æŒç¨³å®š (<1e-5)")
    else:
        print(f"  âš  è­¦å‘Š: æŸäº›ä½ç½®çš„èŒƒæ•°å·®å¼‚è¶…å‡ºå®¹å·®èŒƒå›´ (æœ€å¤§å·®å¼‚ = {max_diff:.6f})")
    
    # éªŒè¯ç›¸å¯¹ä½ç½®æ€§è´¨
    print("\nğŸŒ ç›¸å¯¹ä½ç½®ç‰¹æ€§éªŒè¯:")
    print("  è®¡ç®—ä½ç½®0ä¸å…¶ä»–ä½ç½®çš„ç›¸ä¼¼åº¦...")
    print("  (RoPEä¸­ï¼Œç›¸ä¼¼åº¦åº”éšä½ç½®å·®å¢å¤§è€Œå‡å°)")
    
    print("\n  ä½ç½®å¯¹ | ç›¸ä¼¼åº¦ | ä¸å‰ä¸€ä½ç½®å·®å¼‚")
    print("  -------|--------|-----------------")
    
    prev_sim = None
    for pos_diff in [0, 1, 2, 4, 8]:
        if seq_len > pos_diff:
            dot_product = (q_rot[0, 0, 0] @ q_rot[0, 0, pos_diff]).item()
            
            diff_str = ""
            if prev_sim is not None:
                diff = prev_sim - dot_product
                diff_str = f"{diff:+.6f}" if diff > 0 else f"{diff:.6f}"
            
            print(f"  0 vs {pos_diff:2d} | {dot_product:.6f} | {diff_str}")
            prev_sim = dot_product

# æ‰§è¡Œæµ‹è¯•
if __name__ == "__main__":
    test_apply_rotary_pos_emb()
```

ç¨‹åºè¿è¡Œåè¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤º:

```bash
==========================================================================================
ğŸ”¥ æ—‹è½¬ä½ç½®ç¼–ç (RoPE)åº”ç”¨å‡½æ•° - å…¨é¢æµ‹è¯•
==========================================================================================

ğŸ“‹ æµ‹è¯•é…ç½®:
  æ‰¹å¤§å°: 2
  åºåˆ—é•¿åº¦: 16
  æ³¨æ„åŠ›å¤´æ•°é‡: 32
  å¤´ç»´åº¦: 128
  å¤„ç†å‚æ•°æ€»é‡: 262,144 (â‰ˆ0.3M)
  ä½¿ç”¨ RoPE å®ç°: apply_rotary_pos_emb

ğŸ”§ åˆ›å»ºæµ‹è¯•æ•°æ®...

ğŸ“ æ—‹è½¬å‰å¼ é‡å½¢çŠ¶éªŒè¯:
  q å½¢çŠ¶: torch.Size([2, 32, 16, 128]) [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]
  k å½¢çŠ¶: torch.Size([2, 32, 16, 128]) [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]

ğŸ” åŸå§‹æŸ¥è¯¢å‘é‡ (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=0):
  å½¢çŠ¶: torch.Size([128])
  å‰10ä¸ªå…ƒç´ : [ 1.9269  1.4873  0.9007 -2.1055  0.6784 -1.2345 -0.0431 -1.6047 -0.7521
  1.6487]
  èŒƒæ•°: 10.8772

ğŸ” åŸå§‹æŸ¥è¯¢å‘é‡ (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=15):
  å‰10ä¸ªå…ƒç´ : [ 0.5484  0.4577  0.9677 -0.6674  1.6183 -0.2644  1.3541 -0.0709 -0.3697
 -0.246 ]
  èŒƒæ•°: 10.4785

âš™ï¸ ç”Ÿæˆä½ç½®ç¼–ç ...

  ä½ç½®ç¼–ç ï¼ˆæ—‹è½¬çŸ©é˜µï¼‰å½¢çŠ¶éªŒè¯:
  cos å½¢çŠ¶: torch.Size([2, 16, 128]) [æ‰¹å¤§å°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]
  sin å½¢çŠ¶: torch.Size([2, 16, 128]) [æ‰¹å¤§å°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]

ğŸ“Š ä½ç½®ç¼–ç ç¤ºä¾‹:
  æ‰¹æ¬¡=0, ä½ç½®=0:
    cos[:10]: [1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]
    sin[:10]: [0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
  æ‰¹æ¬¡=0, ä½ç½®=1:
    cos[:10]: [0.995  0.995  0.9988 0.9988 0.9997 0.9997 0.9999 0.9999 1.     1.    ]
    sin[:10]: [0.0998 0.0998 0.05   0.05   0.025  0.025  0.0125 0.0125 0.0062 0.0062]

âš¡ åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç ...
  âœ… æ—‹è½¬åº”ç”¨æˆåŠŸ

ğŸ“ æ—‹è½¬åå¼ é‡å½¢çŠ¶éªŒè¯:
  q_embed å½¢çŠ¶: torch.Size([2, 32, 16, 128]) [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]
  k_embed å½¢çŠ¶: torch.Size([2, 32, 16, 128]) [æ‰¹å¤§å°, å¤´æ•°, åºåˆ—é•¿åº¦, å¤´ç»´åº¦]

âœ… è¾“å‡ºéªŒè¯:
  æ—‹è½¬åæŸ¥è¯¢å‘é‡å½¢çŠ¶: torch.Size([2, 32, 16, 128]) (åº”ä¸è¾“å…¥ç›¸åŒ)
  æ—‹è½¬åé”®å‘é‡å½¢çŠ¶: torch.Size([2, 32, 16, 128])

ğŸ”„ æ—‹è½¬å‰åå¯¹æ¯” (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=0):
  åŸå§‹å‘é‡:
    å‰10ä¸ªå…ƒç´ : [ 1.9269  1.4873  0.9007 -2.1055  0.6784 -1.2345 -0.0431 -1.6047 -0.7521
  1.6487]
    èŒƒæ•°: 10.8772
  æ—‹è½¬åå‘é‡:
    å‰10ä¸ªå…ƒç´ : [ 1.9269  1.4873  0.9007 -2.1055  0.6784 -1.2345 -0.0431 -1.6047 -0.7521
  1.6487]
    èŒƒæ•°: 10.8772

ğŸ”„ æ—‹è½¬å‰åå¯¹æ¯” (æ‰¹æ¬¡=0, å¤´=0, ä½ç½®=15):
  åŸå§‹å‘é‡:
    å‰10ä¸ªå…ƒç´ : [ 0.5484  0.4577  0.9677 -0.6674  1.6183 -0.2644  1.3541 -0.0709 -0.3697
 -0.246 ]
    èŒƒæ•°: 10.4785
  æ—‹è½¬åå‘é‡:
    å‰10ä¸ªå…ƒç´ : [-0.6945  0.301   0.4007 -0.5162  1.5313 -0.3407  1.2414  0.2079 -0.247
 -0.3272]
    èŒƒæ•°: 10.4008

ğŸ” èŒƒæ•°ä¿æŒéªŒè¯:
  æœ€å¤§èŒƒæ•°å·®å¼‚: 0.487347
  âš  è­¦å‘Š: æŸäº›ä½ç½®çš„èŒƒæ•°å·®å¼‚è¶…å‡ºå®¹å·®èŒƒå›´ (æœ€å¤§å·®å¼‚ = 0.487347)

ğŸŒ ç›¸å¯¹ä½ç½®ç‰¹æ€§éªŒè¯:
  è®¡ç®—ä½ç½®0ä¸å…¶ä»–ä½ç½®çš„ç›¸ä¼¼åº¦...
  (RoPEä¸­ï¼Œç›¸ä¼¼åº¦åº”éšä½ç½®å·®å¢å¤§è€Œå‡å°)

  ä½ç½®å¯¹ | ç›¸ä¼¼åº¦ | ä¸å‰ä¸€ä½ç½®å·®å¼‚
  -------|--------|-----------------
  0 vs  0 | 118.314240 | 
  0 vs  1 | 20.345375 | +97.968864
  0 vs  2 | -4.198829 | +24.544204
  0 vs  4 | 8.441195 | -12.640023
  0 vs  8 | -8.702080 | +17.143274
```

## å‚è€ƒèµ„æ–™

- [RoFormer: Enhanced Transformer with Rotary Position Embedding](https://arxiv.org/abs/2104.09864)
- [ååˆ†é’Ÿè¯»æ‡‚æ—‹è½¬ç¼–ç ï¼ˆRoPEï¼‰](https://zhuanlan.zhihu.com/p/647109286)
- [ä¸€æ–‡çœ‹æ‡‚ LLaMA ä¸­çš„æ—‹è½¬å¼ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼‰](https://zhuanlan.zhihu.com/p/642884818)
- [å›¾è§£RoPEæ—‹è½¬ä½ç½®ç¼–ç åŠå…¶ç‰¹æ€§](https://mp.weixin.qq.com/s/-1xVXjoM0imXMC7DKqo-Gw)